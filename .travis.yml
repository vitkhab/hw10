sudo: false
language: python
cache:
  directories:
  - "$HOME/google-cloud-sdk/"
  - "$HOME/bin/"
env:
- PROJECT="docker-181710"
  PATH=$PATH:${HOME}/google-cloud-sdk/bin:${HOME}/bin
  CLOUDSDK_CORE_DISABLE_PROMPTS=1
  GOOGLE_APPLICATION_CREDENTIALS="credentials.json"
before_install:
- openssl aes-256-cbc -K $encrypted_639693b2125e_key -iv $encrypted_639693b2125e_iv
  -in travis/secrets.zip.enc -out secrets.zip -d
- unzip secrets.zip
- if [ ! -d "${HOME}/google-cloud-sdk/bin" ];
  then rm -rf $HOME/google-cloud-sdk;
  curl https://sdk.cloud.google.com | bash > /dev/null; fi
- gcloud version
- gcloud auth activate-service-account --key-file credentials.json
install:
- pip install -r ansible/requirements.txt
- if [ ! -e ${HOME}/bin/packer ];
  then wget https://releases.hashicorp.com/packer/1.1.3/packer_1.1.3_linux_amd64.zip;
  unzip packer_1.1.3_linux_amd64.zip -d $HOME/bin/; fi
script:
- packer build -var "project_id=$PROJECT" -var "source_image=ubuntu-1604-lts" packer/app.json
- export APP_IMAGE=`jq -r '.builds[0].artifact_id' app-output.json`
- echo $APP_IMAGE
- packer build -var "project_id=$PROJECT" -var "source_image=ubuntu-1604-lts" packer/db.json
- export DB_IMAGE=`jq -r '.builds[0].artifact_id' db-output.json`
- echo $DB_IMAGE
- gcloud compute instances create "travis-reddit-app" --image "$APP_IMAGE" 
  --project $PROJECT --zone "europe-west1-b"
- gcloud compute instances create "travis-reddit-db" --image "$DB_IMAGE
  --project $PROJECT --zone "europe-west1-b"
- export EXTERNAL_IP=`gcloud compute instances list --project $PROJECT
  --filter="name=travis-reddit-app" --format='value(EXTERNAL_IP)'`
- echo $EXTERNAL_IP
- ssh -o StrictHostKeyChecking=no appuser@$EXTERNAL_IP '
    git clone https://github.com/Otus-DevOps-2017-11/reddit.git;
    cd reddit && bundle install;
    puma -d'
- sleep 5 && curl -s -o /dev/null -I -w "%{http_code}" --retry 10 --retry-delay 10
  $EXTERNAL_IP:9292
after_script:
- gcloud compute images delete --project $PROJECT -q $IMAGE
- gcloud compute instances delete -q travis-reddit-app
  --project $PROJECT --zone "europe-west1-b"
- gcloud compute instances delete -q travis-reddit-db
  --project $PROJECT --zone "europe-west1-b"
